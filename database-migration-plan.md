# NexSpace Database Migration Plan

## Current Database Analysis

### Table Summary (51 tables total)
- **Core Tables**: users (37 rows), facilities (19 rows), staff (83 rows), shifts (19 rows)
- **Supporting Tables**: teams (8 rows), permissions (0 rows), role_permissions (0 rows)
- **Session Management**: session (1 row), user_sessions (0 rows)
- **Many auxiliary tables with 0-5 rows of data**

## Backup Command
```bash
# Full database backup
pg_dump $DATABASE_URL > nexspace_backup_$(date +%Y%m%d_%H%M%S).sql

# Schema-only backup
pg_dump $DATABASE_URL --schema-only > nexspace_schema_backup.sql

# Data-only backup
pg_dump $DATABASE_URL --data-only > nexspace_data_backup.sql
```

## Proposed Cleaned Schema (Minimal Breaking Changes)

### Core Tables to Keep (with minor cleanup):
1. **users** - Main authentication table (keep as-is, already has joshburn)
2. **facilities** - Healthcare facilities (keep all 58 columns)
3. **staff** - Staff members (keep all 36 columns)
4. **shifts** - Shift scheduling (keep all 21 columns)
5. **permissions** - RBAC permissions (populate missing data)
6. **role_permissions** - Role-permission mappings (populate missing data)
7. **session** - PostgreSQL session store (keep as-is)

### Tables to Consolidate:
- Merge `facility_users` into `users` (add facility-specific fields)
- Keep `teams` and related tables
- Keep all audit/logging tables

### Data Preservation Strategy:
1. Keep all existing data
2. Add missing permissions data
3. Ensure joshburn user exists with proper role
4. Add sample data only where tables are empty

## Migration Steps:

### Step 1: Add Missing Permissions
```sql
-- Add core permissions if not exist
INSERT INTO permissions (name, description, category) VALUES
  ('dashboard.view', 'View dashboard', 'Dashboard'),
  ('facilities.view', 'View facilities', 'Facilities'),
  ('facilities.create', 'Create facilities', 'Facilities'),
  ('facilities.edit', 'Edit facilities', 'Facilities'),
  ('facilities.delete', 'Delete facilities', 'Facilities'),
  ('staff.view', 'View staff', 'Staff'),
  ('staff.create', 'Create staff', 'Staff'),
  ('staff.edit', 'Edit staff', 'Staff'),
  ('staff.delete', 'Delete staff', 'Staff'),
  ('shifts.view', 'View shifts', 'Shifts'),
  ('shifts.create', 'Create shifts', 'Shifts'),
  ('shifts.edit', 'Edit shifts', 'Shifts'),
  ('shifts.delete', 'Delete shifts', 'Shifts'),
  ('settings.view', 'View settings', 'Settings'),
  ('settings.edit', 'Edit settings', 'Settings'),
  ('audit.view', 'View audit logs', 'Audit'),
  ('reports.view', 'View reports', 'Reports'),
  ('reports.generate', 'Generate reports', 'Reports'),
  ('billing.view', 'View billing', 'Billing'),
  ('billing.manage', 'Manage billing', 'Billing'),
  ('users.manage', 'Manage users', 'Users'),
  ('impersonate', 'Impersonate users', 'Admin')
ON CONFLICT (name) DO NOTHING;
```

### Step 2: Setup Role Permissions
```sql
-- Setup super_admin permissions (all permissions)
INSERT INTO role_permissions (role, permission_id)
SELECT 'super_admin', id FROM permissions
ON CONFLICT DO NOTHING;

-- Setup facility_manager permissions
INSERT INTO role_permissions (role, permission_id)
SELECT 'facility_manager', id FROM permissions
WHERE name IN (
  'dashboard.view', 'facilities.view', 'facilities.edit',
  'staff.view', 'staff.create', 'staff.edit',
  'shifts.view', 'shifts.create', 'shifts.edit',
  'reports.view', 'billing.view'
)
ON CONFLICT DO NOTHING;
```

### Step 3: Ensure Admin User Exists
```sql
-- Update or insert joshburn user
INSERT INTO users (
  username, email, password, 
  first_name, last_name, role, 
  is_active, created_at
) VALUES (
  'joshburn', 
  'joshburn99@icloud.com',
  '$2b$10$YourHashedPasswordHere', -- Will be generated by bcrypt
  'Josh',
  'Burn',
  'super_admin',
  true,
  NOW()
)
ON CONFLICT (username) DO UPDATE
SET 
  role = 'super_admin',
  is_active = true,
  email = COALESCE(users.email, EXCLUDED.email);
```

### Step 4: Add Sample Data (Only to Empty Tables)
```sql
-- Add sample facilities if none exist
INSERT INTO facilities (name, address, city, state, zip_code, phone, email, is_active, facility_type, bed_count)
SELECT * FROM (VALUES
  ('Riverside General Hospital', '123 Main St', 'New York', 'NY', '10001', '212-555-0100', 'admin@riverside.com', true, 'hospital', 250),
  ('Sunset Nursing Home', '456 Oak Ave', 'Los Angeles', 'CA', '90001', '310-555-0200', 'admin@sunset.com', true, 'nursing_home', 120),
  ('Mountain View Rehab', '789 Pine Rd', 'Denver', 'CO', '80201', '303-555-0300', 'admin@mountainview.com', true, 'rehabilitation', 80)
) AS v(name, address, city, state, zip_code, phone, email, is_active, facility_type, bed_count)
WHERE NOT EXISTS (SELECT 1 FROM facilities LIMIT 1);

-- Add sample staff if none exist
INSERT INTO staff (name, email, phone, specialty, department, is_active, employment_type)
SELECT * FROM (VALUES
  ('Sarah Johnson', 'sarah.j@example.com', '555-0101', 'Registered Nurse', 'Medical', true, 'full_time'),
  ('Michael Chen', 'michael.c@example.com', '555-0102', 'LPN', 'Surgical', true, 'part_time'),
  ('Emily Davis', 'emily.d@example.com', '555-0103', 'CNA', 'Emergency', true, 'contractor'),
  ('Robert Wilson', 'robert.w@example.com', '555-0104', 'Registered Nurse', 'ICU', true, 'full_time'),
  ('Lisa Anderson', 'lisa.a@example.com', '555-0105', 'Physical Therapist', 'Rehabilitation', true, 'full_time')
) AS v(name, email, phone, specialty, department, is_active, employment_type)
WHERE NOT EXISTS (SELECT 1 FROM staff LIMIT 1);

-- Add sample shifts if none exist
INSERT INTO shifts (
  facility_id, title, department, specialty,
  date, start_time, end_time, status,
  required_staff, rate
)
SELECT 
  f.id, 
  'Morning Shift - ' || f.name,
  'Medical',
  'Registered Nurse',
  CURRENT_DATE + interval '1 day',
  '07:00:00'::time,
  '15:00:00'::time,
  'open',
  2,
  45.00
FROM facilities f
WHERE NOT EXISTS (SELECT 1 FROM shifts WHERE date > CURRENT_DATE)
LIMIT 3;
```

## Implementation Plan:

1. **Backup existing database**
2. **Run migration scripts in transaction**
3. **Verify data integrity**
4. **Update application seed script**
5. **Test authentication and permissions**