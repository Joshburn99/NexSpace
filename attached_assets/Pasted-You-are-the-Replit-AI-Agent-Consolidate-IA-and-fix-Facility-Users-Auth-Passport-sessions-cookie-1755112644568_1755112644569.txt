You are the Replit AI Agent. Consolidate IA and fix Facility Users. Auth = Passport sessions (cookies). ORM = current Drizzle + SQL scripts. Do NOT break SPA routing.

A) Navigation / IA
	1.	Move “User Management” from the ADMIN group to the FACILITIES group and rename to “Facility Users”.
	2.	Route should be canonical at /facilities/users. Add a redirect from /admin/users → /facilities/users.
	3.	Ensure Super Admin sees it; preserve role-based visibility for others.

B) Facility Users page (data + UX)
	1.	The page must read from facility_users table, not users.
	•	Backend: add/verify endpoints:
	•	GET /api/facility-users (list, search by name/email/username)
	•	GET /api/facility-users/:id
	•	POST/PUT/PATCH/DELETE for create/update/archive (guarded)
	•	Frontend: update the data source, table columns, and search.
	2.	Columns: Name, Title/Role(s), Primary Facility, Status, Actions.
	3.	Add loading skeleton, empty state, and error toast with retry. All fetches include credentials: 'include'.

C) Correct the account model (users vs facility_users)

Goal: users table = superusers only. Facility staff live in facility_users.
	1.	Database backup (document + run): pg_dump of the DB before changes.
	2.	Discovery query (paste result in response):
	•	Count rows in users grouped by role.
	•	List any users row where facility_id IS NOT NULL OR specialty IS NOT NULL OR associated_facilities IS NOT NULL.
	3.	Migration plan (idempotent):
	•	For any row in users NOT IN allowed super roles (super_admin, internal_admin) → move to facility_users if not already present (match by email first; if email null, match by username).
	•	Preserve password hash, email, name, phone, etc. Map columns 1:1 where possible.
	•	If both users and facility_users exist for the same email, prefer the existing facility_users row; skip insert and later deactivate the duplicate users record.
	•	After move, deactivate or delete the non-super rows from users (choose soft-delete if possible).
	4.	Constraints / checks (without breaking existing app):
	•	Add a CHECK on users.role IN ('super_admin','internal_admin') if that won’t break inserts; otherwise enforce in code path (server-side guard) and add a comment in schema.
	•	UNIQUE on users.email and users.username (where non-null).
	5.	Seeds / expectations:
	•	Keep only bnangle and joshburn (and any explicitly configured) in users.
	•	Add a small “safety allowlist” (env SUPERUSER_USERNAMES, CSV). Only these can be inserted into users going forward.

D) Auth path clarity (one login endpoint)
	1.	Update /api/auth/login to:
	•	First check users table (superusers).
	•	If not found, check facility_users.
	•	For the session payload, include a clear accountType: 'super' | 'facility' and a normalized role value.
	2.	Ensure /api/auth/me reflects the correct source and role; front-end uses this for RBAC.
	3.	Add unit/integration smoke tests:
	•	superuser login works (from users)
	•	facility user login works (from facility_users)
	•	mixed DB state does not break login

E) Facility Users API wiring
	1.	Implement search: ?q= matches first/last/username/email, and filter by facility: ?facilityId=.
	2.	Return primary and associated facility IDs in the payload; compute primary facility name on the server to avoid N+1.
	3.	Add pagination params ?page=&limit= (default limit 25). Frontend can ignore pagination for now.

F) SPA routing sanity
	1.	Ensure /api routes are registered before any SPA fallback (app.get('*')) so API returns JSON, not HTML.
	2.	Ensure Vite middleware order is correct; static assets are not behind auth.
	3.	Provide two curl transcripts verifying:
	•	GET / returns HTML (SPA)
	•	GET /api/facility-users returns JSON

G) Docs & outputs
	•	Update README “Information Architecture” with the new nav structure (User Management moved under Facilities as Facility Users).
	•	Add a short “Account Model” section explaining: users = superusers, facility_users = facility staff.
	•	Output:
	•	File diffs (nav, routes, server endpoints, auth login/me, facility users page)
	•	The discovery query results (counts and candidate rows)
	•	Changelog (file → why)

Acceptance
	•	Menu shows Facility Users under FACILITIES; /admin/users redirects to /facilities/users.
	•	Facility Users page lists actual facility users from facility_users (not empty).
	•	users table only contains allowed superusers (bnangle, joshburn, plus any allowlisted).
	•	Login works for both super and facility users; /api/auth/me is accurate.
	•	No console errors; typecheck/lint pass.

If any step fails, fix and re-run before responding. Keep all migrations/data moves idempotent and safe to run multiple times.
